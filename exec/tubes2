require 'eventmachine'

module ProxyConnection
  def initialize(client, request)
    @client, @request = client, request
  end

  def post_init
    EM::enable_proxy(self, @client)
  end

  def connection_completed
    send_data @request
  end

  def proxy_target_unbound
    close_connection
  end

  def unbind
    @client.close_connection_after_writing
  end
end

module ProxyServer
  def receive_data(data)
    (@buf ||= "") << data
    if @buf =~ /\r\n\r\n/ # all http headers received
      EventMachine.connect("172.16.238.10", 80, ProxyConnection, self, data)
    end
  end
end

EventMachine.run {
  puts "Starting listening on 0.0.0.0:3003"
  EventMachine.start_server("0.0.0.0", 3003, ProxyServer)
}